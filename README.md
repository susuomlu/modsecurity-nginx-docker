# Containerized Web Application Firewall (WAF)  
ModSecurity 3 + OWASP CRS + NGINX – Production-Ready & Actively Maintained

A complete, secure-by-default reverse proxy + WAF stack that protects any backend (Node.js, PHP, Python, static sites, etc.) with almost zero configuration.

Tested and used in production environments since 2023.

Visit your service securely at: https://<your-ip-or-domain>:8443

## Features & Security Hardening

| Feature                                   | Implemented |
|------------------------------------------|-------------|
| ModSecurity 3 + libmodsecurity           | Yes         |
| Full OWASP Core Rule Set (CRS 4.x)        | Yes Auto-updated |
| Paranoia Level 1–2 by default (PL2 recommended) | Yes      |
| Automatic CRS updates (`update-crs.sh`)   | Yes         |
| Real-time custom rule reloading (no restart) | Yes `watcher.sh` |
| server_tokens off + NGINX version hidden  | Yes         |
| Forced HTTPS + HSTS (2 years)             | Yes         |
| HTTP → HTTPS permanent redirect           | Yes         |
| Global + per-IP rate limiting (10 r/s default) | Yes   |
| Secure HTTP headers (X-Frame-Options, HSTS, CSP, etc.) | Yes |
| Self-signed TLS cert auto-generation      | Yes `cert-gen.sh` |
| All logs shipped to stdout (Docker/K8s ready) | Yes     |
| Custom 403 error page                     | Yes         |
| Runs as non-root (user nginx, UID 101)    | Yes         |
| Tiny final image (~70 MB)                 | Yes         |

## Directory Structure
```bash
├── cert-gen.sh                  # Generates self-signed certs (if you don't provide your own)
├── docker-compose.yml
├── Dockerfile                   # Multi-stage, based on nginx:alpine + ModSecurity
├── update-crs.sh                # Pulls latest OWASP CRS from GitHub
├── watcher.sh                   # Inotify-based auto-reload when rules change
├── modsec-data/
├── certs/                   # Put your real certs here OR let cert-gen.sh create them
├── conf.d/
│   └── node.conf            # Example virtual host (points to nodeapp:3000)
├── crs/
│   ├── crs-setup.conf
│   └── rules/               # Full OWASP CRS lives here
├── custom-rules.conf        # ← Put your own rules here (auto-included)
├── html/
│   └── custom_403.html      # Custom forbidden page
├── logs/                    # Mounted as volume – persists between restarts
│   ├── access.log
│   ├── error.log
│   └── audit.log
├── modsecurity.conf         # Main ModSecurity recommended config
├── nginx.conf               # Hardened nginx config
├── ssl/
│   ├── server.crt           # Generated by cert-gen.sh
│   └── server.key
└── www/                     # Default landing page (optional)
nodeapp/                        # Example protected Node.js app
├── app.js
└── Dockerfile
```
## Quick Start (3 commands)

```bash
# 1. Clone & enter directory
git clone https://github.com/yourname/modsecurity-nginx-waf.git
cd modsecurity-nginx-waf

# 2. Generate self-signed certs (skip if you mount your own in ./modsec-data/certs/)
./cert-gen.sh

# 3. Start everything
docker compose up -d --build
```
Now visit: https://your-server-ip:8443 (accept self-signed cert warning)
Your Node.js example app will be available and fully protected by the WAF.

## Useful Commands
```bash
Bash# Rebuild after changes
docker compose build --no-cache

# View live logs
docker compose logs -f modsec

# Update OWASP CRS to latest version
docker exec -it modsec /usr/local/bin/update-crs.sh

# Manually reload rules (also done automatically by watcher.sh)
docker exec -it modsec nginx -s reload

# Stop everything
docker compose down -v
```
## Custom Rules (just edit one file!)
```bash
Edit modsec-data/custom-rules.conf – changes are picked up within seconds.
apache# Block specific parameter value
SecRule ARGS:testparam "@streq badvalue" \
    "id:10001,phase:2,deny,status:403,log,msg:'Blocked testparam'"

# Block curl/scanner User-Agents
SecRule REQUEST_HEADERS:User-Agent "@contains curl" \
    "id:10002,phase:1,deny,status:403,log,msg:'curl UA blocked'"

# Aggressive SQLi / XXE / Path Traversal
SecRule ARGS "@detectSQLi "@detectSQLi" \
    "id:10003,phase:2,deny,status:403,log,msg:'SQLi attempt blocked'"
```
##  Using Your Own TLS Certificates
Just overwrite/replace the files:
cp /path/to/fullchain.pem modsec-data/certs/fullchain.pem
cp /path/to/privkey.pem   modsec-data/certs/privkey.pem
Then restart: docker compose up -d --force-recreate modsec

